<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="[Go] mplus ğŸš - è½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶">
<meta itemprop="description" content="mplus æ˜¯ä¸€ä¸ªè½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶ã€‚å…·æœ‰ä»¥ä¸‹ç‰¹è‰²ï¼š
 èƒ½å¤Ÿçµæ´»çš„å°†å¤§é‡ middleware ç»„åˆæˆä¸€ä¸ª http-Handler ç›´æ¥ä½¿ç”¨ã€‚ èƒ½å¤Ÿåœ¨è§„åˆ’è·¯ç”±çš„æ—¶å€™å®šä¹‰éœ€è¦ç»‘å®šè¯·æ±‚æ•°æ®çš„ model åŠæ ¡éªŒè§„åˆ™ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ª Handler å†…å¤„ç†ç»‘å®šåŠæ ¡éªŒé€»è¾‘ã€‚ èƒ½å¤Ÿä¸ºä½ çš„è·¯ç”±è®¾ç½®å‰ç½®æˆ–åç½®å¤„ç†å™¨ï¼ˆç±»ä¼¼ middlewareï¼‰ã€‚ æ— éœ€æ”¹å˜ä½ çš„è·¯ç”±å®šä¹‰ï¼Œå®Œå…¨å…¼å®¹ http è§„èŒƒã€‚ åœ¨ Handler å†…æ‰˜ç®¡ http.ResponseWriter åŠ http.Request ï¼Œåç»­ä»£ç é€šè¿‡ç®€ä¾¿çš„ API å®Œæˆè¯·æ±‚çš„å“åº”ã€‚ æä¾›äº† Query å¯¹è±¡ï¼Œèƒ½å¤ŸåŠ¨æ€åœ°é“¾å¼å®Œæˆ URI åŠå­—æ®µå€¼çš„æ‹¼æ¥ï¼Œè€Œéå®˜æ–¹ç¹æ‚çš„å¤„ç†æµç¨‹ã€‚ é€šè¿‡æ³¨å†Œ errCode ï¼Œè‡ªåŠ¨å®Œæˆå¯¹åº”çš„å“åº”çŠ¶æ€ç åŠå“åº”æ¶ˆæ¯å¤„ç†ã€‚ æä¾›é‡å¤è¯»å– request.Body å†…å®¹çš„ APIã€‚ çµæ´»é…åˆå…¶ä»–æ¡†æ¶ä½¿ç”¨ã€‚  å¼•å…¥ mplus  use the below Go command to install mplus  $ go get -u github.com/tangzixiang/mplus Import it in your code:  import &#34;github.com/tangzixiang/mplus&#34; å¿«é€Ÿå¼€å§‹ # assume the following codes in simple.">
<meta itemprop="datePublished" content="2019-12-27T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-12-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2097">
<meta itemprop="image" content="https://picsum.photos/1024/768/?random">



<meta itemprop="keywords" content="" /><meta property="og:title" content="[Go] mplus ğŸš - è½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶" />
<meta property="og:description" content="mplus æ˜¯ä¸€ä¸ªè½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶ã€‚å…·æœ‰ä»¥ä¸‹ç‰¹è‰²ï¼š
 èƒ½å¤Ÿçµæ´»çš„å°†å¤§é‡ middleware ç»„åˆæˆä¸€ä¸ª http-Handler ç›´æ¥ä½¿ç”¨ã€‚ èƒ½å¤Ÿåœ¨è§„åˆ’è·¯ç”±çš„æ—¶å€™å®šä¹‰éœ€è¦ç»‘å®šè¯·æ±‚æ•°æ®çš„ model åŠæ ¡éªŒè§„åˆ™ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ª Handler å†…å¤„ç†ç»‘å®šåŠæ ¡éªŒé€»è¾‘ã€‚ èƒ½å¤Ÿä¸ºä½ çš„è·¯ç”±è®¾ç½®å‰ç½®æˆ–åç½®å¤„ç†å™¨ï¼ˆç±»ä¼¼ middlewareï¼‰ã€‚ æ— éœ€æ”¹å˜ä½ çš„è·¯ç”±å®šä¹‰ï¼Œå®Œå…¨å…¼å®¹ http è§„èŒƒã€‚ åœ¨ Handler å†…æ‰˜ç®¡ http.ResponseWriter åŠ http.Request ï¼Œåç»­ä»£ç é€šè¿‡ç®€ä¾¿çš„ API å®Œæˆè¯·æ±‚çš„å“åº”ã€‚ æä¾›äº† Query å¯¹è±¡ï¼Œèƒ½å¤ŸåŠ¨æ€åœ°é“¾å¼å®Œæˆ URI åŠå­—æ®µå€¼çš„æ‹¼æ¥ï¼Œè€Œéå®˜æ–¹ç¹æ‚çš„å¤„ç†æµç¨‹ã€‚ é€šè¿‡æ³¨å†Œ errCode ï¼Œè‡ªåŠ¨å®Œæˆå¯¹åº”çš„å“åº”çŠ¶æ€ç åŠå“åº”æ¶ˆæ¯å¤„ç†ã€‚ æä¾›é‡å¤è¯»å– request.Body å†…å®¹çš„ APIã€‚ çµæ´»é…åˆå…¶ä»–æ¡†æ¶ä½¿ç”¨ã€‚  å¼•å…¥ mplus  use the below Go command to install mplus  $ go get -u github.com/tangzixiang/mplus Import it in your code:  import &#34;github.com/tangzixiang/mplus&#34; å¿«é€Ÿå¼€å§‹ # assume the following codes in simple." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tangzixiang.github.io/posts/2019/mplus/" />
<meta property="og:image" content="https://picsum.photos/1024/768/?random" />
<meta property="article:published_time" content="2019-12-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-12-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://picsum.photos/1024/768/?random"/>

<meta name="twitter:title" content="[Go] mplus ğŸš - è½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶"/>
<meta name="twitter:description" content="mplus æ˜¯ä¸€ä¸ªè½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶ã€‚å…·æœ‰ä»¥ä¸‹ç‰¹è‰²ï¼š
 èƒ½å¤Ÿçµæ´»çš„å°†å¤§é‡ middleware ç»„åˆæˆä¸€ä¸ª http-Handler ç›´æ¥ä½¿ç”¨ã€‚ èƒ½å¤Ÿåœ¨è§„åˆ’è·¯ç”±çš„æ—¶å€™å®šä¹‰éœ€è¦ç»‘å®šè¯·æ±‚æ•°æ®çš„ model åŠæ ¡éªŒè§„åˆ™ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ª Handler å†…å¤„ç†ç»‘å®šåŠæ ¡éªŒé€»è¾‘ã€‚ èƒ½å¤Ÿä¸ºä½ çš„è·¯ç”±è®¾ç½®å‰ç½®æˆ–åç½®å¤„ç†å™¨ï¼ˆç±»ä¼¼ middlewareï¼‰ã€‚ æ— éœ€æ”¹å˜ä½ çš„è·¯ç”±å®šä¹‰ï¼Œå®Œå…¨å…¼å®¹ http è§„èŒƒã€‚ åœ¨ Handler å†…æ‰˜ç®¡ http.ResponseWriter åŠ http.Request ï¼Œåç»­ä»£ç é€šè¿‡ç®€ä¾¿çš„ API å®Œæˆè¯·æ±‚çš„å“åº”ã€‚ æä¾›äº† Query å¯¹è±¡ï¼Œèƒ½å¤ŸåŠ¨æ€åœ°é“¾å¼å®Œæˆ URI åŠå­—æ®µå€¼çš„æ‹¼æ¥ï¼Œè€Œéå®˜æ–¹ç¹æ‚çš„å¤„ç†æµç¨‹ã€‚ é€šè¿‡æ³¨å†Œ errCode ï¼Œè‡ªåŠ¨å®Œæˆå¯¹åº”çš„å“åº”çŠ¶æ€ç åŠå“åº”æ¶ˆæ¯å¤„ç†ã€‚ æä¾›é‡å¤è¯»å– request.Body å†…å®¹çš„ APIã€‚ çµæ´»é…åˆå…¶ä»–æ¡†æ¶ä½¿ç”¨ã€‚  å¼•å…¥ mplus  use the below Go command to install mplus  $ go get -u github.com/tangzixiang/mplus Import it in your code:  import &#34;github.com/tangzixiang/mplus&#34; å¿«é€Ÿå¼€å§‹ # assume the following codes in simple."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>[Go] mplus ğŸš - è½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶</title>
	<link rel="stylesheet" href="https://tangzixiang.github.io/css/style.min.657bcb7af31123e4156b1a3d2ff60a636717e54ead74f882136b5114cf72b55e.css" integrity="sha256-ZXvLevMRI+QVaxo9L/YKY2cX5U6tdPiCE2tRFM9ytV4=" crossorigin="anonymous">
	<style>.bg-img {background-image: url('https://picsum.photos/1024/768/?random');}</style>
	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "https://hm.baidu.com/hm.js?1ba208d8ae909608e34daa6b208298df";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
	
	<style type="text/css">
		.hdr-left iframe{
			float: right;
			margin-left: 1em;
			margin-top: .03em;
		}

		#home-nav iframe{
			display: block;
		    text-align: center;
		    margin-top: .5em;
		    margin-left: auto;
		    margin-right: auto;
		}
	</style>
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://tangzixiang.github.io/">tangzixiang&#39;s blog</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://tangzixiang.github.io/posts/">æ‰€æœ‰æ–‡ç« </a>
				<a href="https://tangzixiang.github.io/opensource/">å¼€æº</a>
				<a href="https://tangzixiang.github.io/daily/">è¯­å½•</a>
				<a href="https://tangzixiang.github.io/sharesites/">ç«™ç‚¹</a>
				<a href="https://tangzixiang.github.io/course/">è¯¾ç¨‹</a>
		
		<iframe src="https://ghbtns.com/github-btn.html?user=tangzixiang&type=follow&count=true&size=large" frameborder="0" scrolling="0" width="200px" height="30px"></iframe>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="img-btn" class="hdr-btn" title="Featured Image"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></button><button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/tangzixiang" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://segmentfault.com/u/tomson" target="_blank" rel="noopener me" title="segmentfault" style="margin-left: .5em;">sf</a>
<a href="https://www.zhihu.com/people/tomson-3/collections" target="_blank" rel="noopener me" title="çŸ¥ä¹">çŸ¥</a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://tangzixiang.github.io/posts/">æ‰€æœ‰æ–‡ç« </a></li>
			<li><a href="https://tangzixiang.github.io/opensource/">å¼€æº</a></li>
			<li><a href="https://tangzixiang.github.io/daily/">è¯­å½•</a></li>
			<li><a href="https://tangzixiang.github.io/sharesites/">ç«™ç‚¹</a></li>
			<li><a href="https://tangzixiang.github.io/course/">è¯¾ç¨‹</a></li>
		</ul>
	</div>


	<div class="bg-img"></div>
	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Dec 27, 2019</span></div>
				<h1>[Go] mplus ğŸš - è½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶</h1>
			</header>
			<div class="content">
				<p><iframe src="https://ghbtns.com/github-btn.html?user=tangzixiang&repo=mplus&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>

<iframe src="https://ghbtns.com/github-btn.html?user=tangzixiang&type=follow&count=true&size=large" frameborder="0" scrolling="0" width="220px" height="30px"></iframe></p>
<p><strong>mplus</strong> æ˜¯ä¸€ä¸ªè½»é‡çº§çš„éä¾µå…¥å¼ http è¯·æ±‚å¤„ç†è¾…åŠ©æ¡†æ¶ã€‚å…·æœ‰ä»¥ä¸‹ç‰¹è‰²ï¼š</p>
<ul>
<li>èƒ½å¤Ÿçµæ´»çš„å°†å¤§é‡ middleware ç»„åˆæˆä¸€ä¸ª http-Handler ç›´æ¥ä½¿ç”¨ã€‚</li>
<li>èƒ½å¤Ÿåœ¨è§„åˆ’è·¯ç”±çš„æ—¶å€™å®šä¹‰éœ€è¦ç»‘å®šè¯·æ±‚æ•°æ®çš„ model åŠæ ¡éªŒè§„åˆ™ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ª Handler å†…å¤„ç†ç»‘å®šåŠæ ¡éªŒé€»è¾‘ã€‚</li>
<li>èƒ½å¤Ÿä¸ºä½ çš„è·¯ç”±è®¾ç½®å‰ç½®æˆ–åç½®å¤„ç†å™¨ï¼ˆç±»ä¼¼ middlewareï¼‰ã€‚</li>
<li>æ— éœ€æ”¹å˜ä½ çš„è·¯ç”±å®šä¹‰ï¼Œå®Œå…¨å…¼å®¹ http è§„èŒƒã€‚</li>
<li>åœ¨ Handler å†…æ‰˜ç®¡ <code>http.ResponseWriter</code> åŠ <code>http.Request</code> ï¼Œåç»­ä»£ç é€šè¿‡ç®€ä¾¿çš„ API å®Œæˆè¯·æ±‚çš„å“åº”ã€‚</li>
<li>æä¾›äº† Query å¯¹è±¡ï¼Œèƒ½å¤ŸåŠ¨æ€åœ°é“¾å¼å®Œæˆ <code>URI</code> åŠå­—æ®µå€¼çš„æ‹¼æ¥ï¼Œè€Œéå®˜æ–¹ç¹æ‚çš„å¤„ç†æµç¨‹ã€‚</li>
<li>é€šè¿‡æ³¨å†Œ errCode ï¼Œè‡ªåŠ¨å®Œæˆå¯¹åº”çš„å“åº”çŠ¶æ€ç åŠå“åº”æ¶ˆæ¯å¤„ç†ã€‚</li>
<li>æä¾›é‡å¤è¯»å– request.Body å†…å®¹çš„ APIã€‚</li>
<li>çµæ´»é…åˆå…¶ä»–æ¡†æ¶ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="-mplus">å¼•å…¥ mplus<a href="#-mplus" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ol>
<li>use the below Go command to install mplus</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ go get -u github.com/tangzixiang/mplus
</code></pre></div><ol start="2">
<li>Import it in your code:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/tangzixiang/mplus&#34;</span>
</code></pre></div><h2 id="heading">å¿«é€Ÿå¼€å§‹<a href="#heading" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># assume the following codes in simple.go file</span>
$ cat simple.go
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;github.com/tangzixiang/mplus&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Hello</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Hello</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// take you w,r then give you a plus
</span><span class="c1"></span>	<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="s">&#34;hello world&#34;</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># run server</span>
$ go run simple.go
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># request the server api</span>
$ curl localhost:8080

<span class="o">{</span><span class="s2">&#34;data&#34;</span>:<span class="s2">&#34;hello world&#34;</span><span class="o">}</span>
</code></pre></div><h2 id="heading1">åŠŸèƒ½<a href="#heading1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="heading2">ä½¿ç”¨è‡ªå®šä¹‰ä¸­é—´ä»¶<a href="#heading2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>æ°å½“çš„ä½¿ç”¨ä¸­é—´ä»¶ï¼Œèƒ½å¤Ÿå¤§å¤§æå‡ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œä½¿ç”¨ä¸­é—´ä»¶èƒ½å¤Ÿå®ç° <a href="%5Bhttps://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%9A%84%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%5D(https://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%9A%84%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1)"><code>AOP</code></a> é¢å‘åˆ‡é¢ç¼–ç¨‹çš„æ€æƒ³ï¼Œé™ä½ä»£ç çš„è€¦åˆåº¦ã€‚</p>
<blockquote>
<p><strong>é¢å‘åˆ‡é¢çš„ç¨‹åºè®¾è®¡</strong>ï¼ˆAspect-oriented programmingï¼ŒAOPï¼Œåˆè¯‘ä½œ<strong>é¢å‘æ–¹é¢çš„ç¨‹åºè®¾è®¡</strong>ã€<strong>å‰–é¢å¯¼å‘ç¨‹åºè®¾è®¡</strong>ï¼‰æ˜¯<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6">è®¡ç®—æœºç§‘å­¦</a>ä¸­çš„ä¸€ç§<a href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%9E%8B">ç¨‹åºè®¾è®¡æ€æƒ³</a>ï¼Œæ—¨åœ¨å°†<strong>æ¨ªåˆ‡å…³æ³¨ç‚¹</strong>ä¸ä¸šåŠ¡ä¸»ä½“è¿›è¡Œè¿›ä¸€æ­¥åˆ†ç¦»ï¼Œä»¥æé«˜ç¨‹åºä»£ç çš„æ¨¡å—åŒ–ç¨‹åº¦</p>
</blockquote>
<p><strong>mplus</strong> çš„ä¸­é—´ä»¶åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p>
<ul>
<li><strong>å‰ç½®è¯·æ±‚å¤„ç†å™¨</strong>ï¼šåªåœ¨ Handler å‰æ‰§è¡Œ</li>
<li><strong>åç½®è¯·æ±‚å¤„ç†å™¨</strong>ï¼šåªåœ¨ Handler åæ‰§è¡Œ</li>
<li><strong>middleware</strong> ï¼šè‡ªå®šä¹‰ä¸ Handler ä¹‹é—´çš„æ‰§è¡Œå…³ç³»</li>
</ul>
<h4 id="heading3">è®¾ç½®å‰ç½®è¯·æ±‚å¤„ç†å™¨å®Œæˆè®¡æ•°åŠŸèƒ½<a href="#heading3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>ä½¿ç”¨å‰ç½®è¯·æ±‚å¤„ç†å™¨ï¼Œèƒ½ä¸ºä½ å°† Handler å†…çš„éƒ¨åˆ†å‰ç½®é€»è¾‘è¿›è¡ŒæŠ½ç¦»ï¼Œæä¾›æ›´å¥½çš„å¯ç»´æŠ¤æ€§ã€‚</p>
<ul>
<li><code>mplus.MRote().Before(...http.HandlerFunc)</code> ä¸ºå½“å‰è¯·æ±‚æ·»åŠ å‰ç½®è¯·æ±‚å¤„ç†</li>
<li><code>mplus.MRote().BeforeHandler(...http.Handler)</code> ä¸ºå½“å‰è¯·æ±‚æ·»åŠ å‰ç½®è¯·æ±‚å¤„ç†</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">num</span> <span class="p">=</span> <span class="mi">0</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Before</span><span class="p">(</span><span class="nx">AddNum</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Num</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// increase num per request
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">AddNum</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">num</span> <span class="o">++</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Num</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;num&#34;</span><span class="p">:</span> <span class="nx">num</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><h4 id="heading4">åŒæ—¶ä½¿ç”¨å‰ç½®åŠåç½®è¯·æ±‚å¤„ç†å™¨æ§åˆ¶è®¿é—®é‡<a href="#heading4" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>åŒæ ·çš„ï¼Œä½ èƒ½ä¸ºä½ çš„ Handler ä¸­çš„éƒ¨åˆ†é€»è¾‘æ·»åŠ è‡³åç½®è¯·æ±‚å¤„ç†å™¨ï¼Œåœ¨åç½®å¤„ç†å™¨ä¸­ï¼Œä½ èƒ½åšä¸€äº›ä¸å½±å“å½“å‰ä¸šåŠ¡çš„é™„å¸¦è¡Œä¸ºã€‚</p>
<ul>
<li><code>mplus.MRote().After(...http.HandlerFunc)</code> ä¸ºå½“å‰è¯·æ±‚æ·»åŠ åç½®è¯·æ±‚å¤„ç†</li>
<li><code>mplus.MRote().AfterHandler(...http.Handler)</code> ä¸ºå½“å‰è¯·æ±‚æ·»åŠ åç½®è¯·æ±‚å¤„ç†</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">lastVisitIndex</span> <span class="p">=</span> <span class="mi">0</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span>
               <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Before</span><span class="p">(</span><span class="nx">MaxVisitTimesControl</span><span class="p">)</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">AddNum</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Num</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// MaxVisitTimesControl as a before handler control visit times
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">MaxVisitTimesControl</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">lastVisitIndex</span> <span class="p">&gt;</span> <span class="mi">10</span> <span class="p">{</span>
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">Forbidden</span><span class="p">(</span><span class="p">)</span> <span class="c1">// return status cod 403
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// AddNum as an after handler increase num per request
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">AddNum</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">lastVisitIndex</span> <span class="o">++</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Num</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="s">&#34;num&#34;</span><span class="p">:</span> <span class="nx">lastVisitIndex</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h4 id="-middleware-">ä½¿ç”¨ middleware ä¸­é—´ä»¶<a href="#-middleware-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ middleware çµæ´»æ§åˆ¶ä¸ Handler çš„å…³ç³»</p>
<ul>
<li><code>mplus.MRote().Use(...MiddlewareHandlerFunc)</code> ä¸ºå½“å‰è¯·æ±‚ç»„åˆä¸­é—´ä»¶</li>
<li><code>mplus.MRote().UseHandlerMiddleware(...MiddlewareHandler)</code> ä¸ºå½“å‰è¯·æ±‚ç»„åˆä¸­é—´ä»¶</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">SetRequestID</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Hello</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// use middleware to set requestID per request
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SetRequestID</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderRequestID</span><span class="p">,</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">uuid</span><span class="p">.</span><span class="nf">NewV4</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="c1">// &#34;X-Request-Id&#34;
</span><span class="c1"></span>
		<span class="c1">// call next ,may be is Handler or next middleware
</span><span class="c1"></span>		<span class="nx">next</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Hello</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="s">&#34;hello world&#34;</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><p><strong>mplus</strong> åŒæ—¶æ”¯æŒåœ¨ middleware ä¸­ä½¿ç”¨ï¼Œé™¤äº†èƒ½å¤Ÿå¸®ä½ æ‰˜ç®¡ <code>ResponseWriter</code> å’Œ <code>Request</code> è¿˜æ”¯æŒæ‰˜ç®¡ <code>http.Handler</code> å³ä¸Šè¿° <code>SetRequestID</code> middleware çš„ <code>next</code> å‚æ•°ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// use middleware to set requestID per request
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SetRequestID</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>

	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    
		<span class="c1">// write &#34;X-Request-Id&#34; to respâ€™s head then call next by mplus which take next handler
</span><span class="c1"></span>		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">WriteRespHeader</span><span class="p">(</span> 
			<span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderRequestID</span><span class="p">,</span><span class="nx">uuid</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">uuid</span><span class="p">.</span><span class="nf">NewV4</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>è¯¥ç‰ˆæœ¬çš„ <code>SetRequestID</code> æ•ˆæœä¸ä¸Šä¸€ä¸ªç‰ˆæœ¬ç›¸åŒã€‚</p>
<h4 id="-httphandler-">ä¸­é—´ä»¶ä¸ HTTP-Handler ä¹‹é—´çš„äº¤äº’<a href="#-httphandler-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>åœ¨æŸäº›æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨ä¸­é—´ä»¶ä¹‹é—´ä¸“é€’ä¿¡æ¯ï¼Œæˆ–åˆ™éœ€è¦å°†ä¿¡æ¯ä»ä¸­é—´ä»¶ä¼ é€’åˆ°å®é™…çš„ Handler ä¸­ã€‚<strong>mplus</strong> æä¾›äº†ç›¸åº”çš„ <code>Get/Set</code> æ–¹æ³•é›†ç”¨äºå¤„ç†ç¼“å­˜äºå½“å‰ä¸Šä¸‹æ–‡ä¸­çš„æ•°æ®</p>
<ul>
<li><code>mplus.PP.Get(key string)</code> ä»å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¸­è·å–æŒ‡å®šæ•°æ®</li>
<li><code>mplus.PP.GetDf(key string, defaultValue interface{})</code> ä»å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¸­è·å–æŒ‡å®šæ•°æ®ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤å€¼</li>
<li><code>mplus.PP.Set(key string, value interface{})</code> å°†æŒ‡å®šæ•°æ®æ”¾å…¥å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¸­</li>
<li><code>mplus.PP.SetR(key string, value interface{})</code> å°†æŒ‡å®šæ•°æ®æ”¾å…¥å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶è¿”å›å½“å‰æ•°æ®</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Name</span> <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;name&#34;</span><span class="s">`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">SetRequestID</span><span class="p">,</span> <span class="nx">PreSearchUser</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Hello</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// use middleware to set requestID per request
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SetRequestID</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>

	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>

		<span class="c1">// add &#34;X-Request-Id&#34; to request&#39;s context and header at the same time
</span><span class="c1"></span>		<span class="nx">pp</span><span class="p">.</span><span class="nf">WriteRespHeader</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderRequestID</span><span class="p">,</span>
			<span class="nx">pp</span><span class="p">.</span><span class="nf">SetStringR</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderRequestID</span><span class="p">,</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">uuid</span><span class="p">.</span><span class="nf">NewV4</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>

		<span class="c1">// call next
</span><span class="c1"></span>		<span class="nx">pp</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">KeyUser</span> <span class="p">=</span> <span class="s">&#34;user&#34;</span>

<span class="c1">// use middleware to check user before handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">PreSearchUser</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>

	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>

		<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>

		<span class="c1">// search user by id which get from url then add to request&#39;s context
</span><span class="c1"></span>		<span class="nx">pp</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">KeyUser</span><span class="p">,</span> <span class="nf">SearchUserService</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>

		<span class="c1">// call next
</span><span class="c1"></span>		<span class="nx">pp</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="p">)</span>
    
		<span class="c1">// Or complete all steps at once as follows
</span><span class="c1"></span>		<span class="c1">// mplus.PlusPlus(w, r).Handler(next).
</span><span class="c1"></span>		<span class="c1">// Set(KeyUser, SearchUserService(pp.Query(&#34;id&#34;))).ServeHTTP()
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">SearchUserService</span><span class="p">(</span><span class="nx">id</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">User</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span><span class="s">&#34;tom&#34;</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Hello</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>

	<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>

	<span class="nx">requestID</span> <span class="o">:=</span> <span class="nx">pp</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderRequestID</span><span class="p">)</span> <span class="c1">// get requestID from request&#39;s context
</span><span class="c1"></span>	<span class="nx">userName</span> <span class="o">:=</span> <span class="nx">pp</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">KeyUser</span><span class="p">)</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">)</span><span class="p">.</span><span class="nx">Name</span>   <span class="c1">// get user from request&#39;s context
</span><span class="c1"></span>
	<span class="nx">pp</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">Data</span><span class="p">{</span><span class="s">&#34;request_id&#34;</span><span class="p">:</span> <span class="nx">requestID</span><span class="p">,</span> <span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;hello &#34;</span> <span class="o">+</span> <span class="nx">userName</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ curl http://localhost:8080?id<span class="o">=</span><span class="m">1</span>

&lt; HTTP/1.1 <span class="m">200</span> OK
<span class="o">{</span><span class="s2">&#34;message&#34;</span>:<span class="s2">&#34;hello tom&#34;</span>,<span class="s2">&#34;request_id&#34;</span>:<span class="s2">&#34;9ccadf01-cfdf-4822-b528-3a1b6e79987a&#34;</span><span class="o">}</span>
</code></pre></div><h4 id="-middleware-1">å‰ç½®/åç½®è¯·æ±‚å¤„ç†å™¨ä¸ middleware ä¸­é—´ä»¶ä¹‹é—´çš„å…³ç³»<a href="#-middleware-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>æ¯ä¸ª Handler éƒ½å¯ä»¥ä¸ä»»æ„çš„ <code>Before</code> ã€ <code>After</code> åŠ <code>middleware</code> è¿›è¡Œæ­é…ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹:</p>
<ul>
<li><code>Before</code> åŠ <code>After</code> ä¸ Handler è¿›è¡Œç»„åˆ, æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</li>
</ul>
<p><img src="https://github.com/tangzixiang/mplus/raw/master/assets/image-20191022142924932.png" alt=""></p>
<ul>
<li><code>middleware</code> ä¸ Handler è¿›è¡Œç»„åˆï¼Œæ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</li>
</ul>
<p><img src="https://github.com/tangzixiang/mplus/raw/master/assets/image-20191022145958986.png" alt=""></p>
<ul>
<li><code>Before</code> ã€ <code>After</code> åŠ <code>middleware</code> åŒæ—¶ä¸ Handler è¿›è¡Œç»„åˆ, æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</li>
</ul>
<p><img src="https://github.com/tangzixiang/mplus/raw/master/assets/image-20191022150601974.png" alt=""></p>
<h3 id="-model-">ç»‘å®š model å¹¶æ ¡éªŒè¯·æ±‚æ•°æ®æœ‰æ•ˆæ€§<a href="#-model-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>åœ¨æ—¥å¸¸çš„ API å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœ¨ Handler ä¸­å°†è¯·æ±‚æ•°æ®æ˜ å°„åˆ°æŒ‡å®šå¯¹è±¡ä¸Šå¹¶è¿›è¡Œæ•°æ®æ ¡éªŒï¼Œç„¶åå†ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹è¿›è¡Œåç»­å¤„ç†ï¼Œç”¨åŸå§‹çš„æ–¹å¼ä½ éœ€è¦å†™å¤§é‡çš„å¤„ç†ä»£ç ï¼Œmplus å¯ä»¥å¤§å¤§é™ä½ä½ çš„ä»£ç é‡ã€‚</p>
<p><strong>mplus</strong> å†…ç½®ä½¿ç”¨ <strong><a href="https://github.com/go-playground/validator">validator</a></strong> ä½œä¸º JSON æ•°æ®è§„åˆ™æ ¡éªŒå¼•æ“</p>
<ul>
<li><code>mplus.MRote().Bind(interface{})</code> ä¸ºå½“å‰è¯·æ±‚ç»‘å®šæŒ‡å®šæ•°æ®ç±»å‹</li>
<li><code>mplus.RegisterValidateErrorFunc(ValidateErrorType,func(http.ResponseWriter,*http.Request, error))</code> æ³¨å†Œä¸€ä¸ªæ•°æ®æ ¡éªŒå¼‚å¸¸å¤„ç† Hook</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">V</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Addr</span> <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;addr&#34; validate:&#34;min=10&#34;</span><span class="s">`</span> <span class="c1">// min len is 10
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// (*V)(nil) mean that is a nil point which hold type info
</span><span class="c1"></span>	<span class="c1">// bind model just need type info
</span><span class="c1"></span>	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Address</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Address</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>

	<span class="c1">// pass to response data is V instance from request data
</span><span class="c1"></span>	<span class="nx">pp</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nf">VO</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># request success</span>
$ curl --request POST <span class="se">\
</span><span class="se"></span>&gt;   --url http://localhost:8080/ <span class="se">\
</span><span class="se"></span>&gt;   --header <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>&gt;   --data <span class="s1">&#39;{&#34;addr&#34;:&#34;å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒº xxx å·&#34;}&#39;</span>

<span class="o">{</span><span class="s2">&#34;addr&#34;</span>:<span class="s2">&#34;å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒº xxx å· :)&#34;</span><span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># request failed</span>
$ curl --request POST <span class="se">\
</span><span class="se"></span>&gt;   --url http://localhost:8080/408 <span class="se">\
</span><span class="se"></span>&gt;   --header <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>&gt;   --data <span class="s1">&#39;{&#34;addr&#34;:&#34;&#34;}&#39;</span> 

&lt; HTTP/1.1 <span class="m">400</span> Bad Request
</code></pre></div><p>å¦‚æœéœ€è¦äº†è§£åˆ°æ ¡éªŒè¿‡ç¨‹ä¸­å…·ä½“å‘ç”Ÿå¼‚å¸¸çš„å†…å®¹ï¼Œå¯ä»¥æ·»åŠ å¦‚ä¸‹ Hook å®šä¹‰å“åº”è¾“å‡ºçš„å†…å®¹</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// register a hook to show err message when validate failed
</span><span class="c1"></span>	<span class="nx">mplus</span><span class="p">.</span><span class="nf">RegisterValidateErrorFunc</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">ErrBodyValidate</span><span class="p">,</span> 
                                  <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
                                    
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">Data</span><span class="p">{</span><span class="s">&#34;err_message&#34;</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">}</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span>

	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Address</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ curl --request POST <span class="se">\
</span><span class="se"></span>&gt;   --url http://localhost:8080/408 <span class="se">\
</span><span class="se"></span>&gt;   --header <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>&gt;   --data <span class="s1">&#39;{&#34;addr&#34;:&#34;&#34;}&#39;</span> 

&lt; HTTP/1.1 <span class="m">400</span> Bad Request
<span class="o">{</span><span class="s2">&#34;err_message&#34;</span>:<span class="s2">&#34;Key: &#39;V.Addr&#39; Error:Field validation for &#39;Addr&#39; failed on the &#39;min&#39; tag&#34;</span><span class="o">}</span>
</code></pre></div><h4 id="form-">form æ•°æ®çš„ç»‘å®š<a href="#form-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p><strong>mplus</strong> åŒæ—¶å†…ç½® <strong><a href="github.com/go-playground/form">form</a></strong> ä½œä¸º  <code>querystring</code> åŠ <code>form</code> æ ¼å¼æ•°æ®çš„è§£æå¼•æ“ï¼Œè¿™æ ·ä½ ä¾¿èƒ½é€šè¿‡ <code>Bind</code> åŒæ—¶ç»‘å®šè¯·æ±‚ä½“æ•°æ®å†…å®¹åŠURL ä¸Šçš„æ•°æ®å†…å®¹</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// tag â€œformâ€, can parse parameter from URL or form-data
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">V</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Addr</span> <span class="kt">string</span> <span class="s">`</span><span class="s">form:&#34;addr&#34; validate:&#34;min=10&#34;</span><span class="s">`</span> <span class="c1">// min len is 10
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># addr on URL</span>
$ curl http://localhost:8080?addr<span class="o">=</span>å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºxxxx

&lt; HTTP/1.1 <span class="m">200</span> OK
<span class="o">{</span><span class="s2">&#34;addr&#34;</span>:<span class="s2">&#34;å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºxxxx&#34;</span><span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># by application/x-www-form-urlencoded</span>
$ curl http://localhost:8080 --data <span class="s1">&#39;addr=å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºxxxx&#39;</span>

&lt; HTTP/1.1 <span class="m">200</span> OK
<span class="o">{</span><span class="s2">&#34;addr&#34;</span>:<span class="s2">&#34;å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºxxxx&#34;</span><span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Request body parameters take precedence over URL query string values</span>
$ curl http://localhost:8080?addr<span class="o">=</span>å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºyyyyy --data <span class="s1">&#39;addr=å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºxxxx&#39;</span>

&lt; HTTP/1.1 <span class="m">200</span> OK
<span class="o">{</span><span class="s2">&#34;addr&#34;</span>:<span class="s2">&#34;å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºxxxx&#34;</span><span class="o">}</span>
</code></pre></div><p>å¦‚æœ <strong><a href="https://github.com/go-playground/validator">validator</a></strong> åŠ  <strong><a href="github.com/go-playground/form">form</a></strong>  ä¸èƒ½æ»¡è¶³ä½ çš„æ ¡éªŒè§„åˆ™ï¼Œä½ è¿˜èƒ½ä¸ºå½“å‰ model è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘è¿›è¡Œè¡¥å……</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">V</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Addr</span> <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;addr&#34; validate:&#34;min=10&#34;</span><span class="s">`</span> <span class="c1">// min len is 10
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// implement mplus.RequestValidate
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="nx">V</span><span class="p">)</span> <span class="nf">Validate</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">ok</span> <span class="kt">bool</span> <span class="cm">/*æ ¡éªŒæ˜¯å¦æˆåŠŸ*/</span><span class="p">,</span> <span class="nx">errMsg</span> <span class="kt">string</span> <span class="cm">/*æ ¡éªŒå¤±è´¥çš„åŸå› */</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Index</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">Addr</span><span class="p">,</span> <span class="s">&#34;å¹¿ä¸œ&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;addr must begin å¹¿ä¸œ&#34;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// register a hook to show err message when validate failed by model.Validate
</span><span class="c1"></span>	<span class="nx">mplus</span><span class="p">.</span><span class="nf">RegisterValidateErrorFunc</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">ErrRequestValidate</span><span class="p">,</span> 
                                  <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
                                    
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;err_message&#34;</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">}</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span>

	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Address</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Address</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>

	<span class="c1">// pass data to response
</span><span class="c1"></span>	<span class="nx">pp</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nf">VO</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ curl --request POST <span class="se">\
</span><span class="se"></span>&gt;   --url http://localhost:8080/ <span class="se">\
</span><span class="se"></span>&gt;   --header <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>&gt;   --data <span class="s1">&#39;{&#34;addr&#34;:&#34;å…¶ä»–çœæ·±åœ³å¸‚å—å±±åŒº xxx å·&#34;}&#39;</span> 

&lt; HTTP/1.1 <span class="m">400</span> Bad Request
<span class="o">{</span><span class="s2">&#34;err_message&#34;</span>:<span class="s2">&#34;addr must begin å¹¿ä¸œ&#34;</span><span class="o">}</span>
</code></pre></div><h4 id="-model-1">å»¶è¿Ÿè®¡ç®— model ç±»å‹<a href="#-model-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>å¦‚æœä½ æ— æ³•åœ¨å£°æ˜è·¯ç”±çš„æ—¶å€™ç›´æ¥ç¡®å®š Handler ç»‘å®šçš„ <code>model</code> ç±»å‹ï¼Œä¼ é€’ä¸€ä¸ªç”¨äºå»¶è¿Ÿè®¡ç®—å®é™…éœ€è¦ç»‘å®šçš„ <code>model</code> ç±»å‹çš„å›è°ƒå‡½æ•°ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// InsertUser use for insert a new one
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">InsertUser</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Account</span>  <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;account&#34;     form:&#34;account&#34;</span><span class="s">`</span>
	<span class="nx">Name</span>     <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;name&#34;        form:&#34;name&#34;</span><span class="s">`</span>
	<span class="nx">Password</span> <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;password&#34;    form:&#34;password&#34;</span><span class="s">`</span>
<span class="p">}</span>

<span class="c1">// UpdateUser use for update name
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">UpdateUser</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Account</span> <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;account&#34;  form:&#34;account&#34;</span><span class="s">`</span>
	<span class="nx">Name</span>    <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;name&#34;     form:&#34;name&#34;</span><span class="s">`</span>
<span class="p">}</span>

<span class="c1">// SelectBindModel will calculate which type of model to bind when handler got a request
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SelectBindModel</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">switch</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">GetHeader</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="s">&#34;X-Do-What&#34;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="s">&#34;update&#34;</span><span class="p">:</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="nx">UpdateUser</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="s">&#34;insert&#34;</span><span class="p">:</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="nx">InsertUser</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
  
	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;bind type not found&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// register a hook to show err message when select model failed
</span><span class="c1"></span>	<span class="nx">mplus</span><span class="p">.</span><span class="nf">RegisterValidateErrorFunc</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">ErrModelSelect</span><span class="p">,</span> 
                                  <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// {&#34;err_message&#34;:&#34;bind type not found&#34;} 400
</span><span class="c1"></span>		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">Data</span><span class="p">{</span><span class="s">&#34;err_message&#34;</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">}</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span>

	<span class="nx">handler</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nf">ValidateFunc</span><span class="p">(</span><span class="nx">SelectBindModel</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Whatever</span><span class="p">)</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span><span class="nx">handler</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Whatever</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>

	<span class="c1">// got pp.VO() do anything
</span><span class="c1"></span>  
	<span class="c1">// pass data to response
</span><span class="c1"></span>	<span class="nx">pp</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nf">VO</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># request failed</span>
$ curl http://localhost:8080

&lt; HTTP/1.1 <span class="m">400</span> Bad Request
<span class="o">{</span><span class="s2">&#34;err_message&#34;</span>:<span class="s2">&#34;bind type not found&#34;</span><span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># request success by application/x-www-form-urlencoded</span>
$ curl http://localhost:8080 --header <span class="s1">&#39;X-Do-What: update&#39;</span> --data <span class="s1">&#39;account=xxx@xxx&amp;name=xxx&#39;</span>

&lt; HTTP/1.1 <span class="m">200</span> OK
<span class="o">{</span><span class="s2">&#34;account&#34;</span>:<span class="s2">&#34;xxx@xxx&#34;</span>,<span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;xxx&#34;</span><span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># request success by application/json</span>
$ curl http://localhost:8080 <span class="se">\
</span><span class="se"></span>&gt;   --header <span class="s1">&#39;X-Do-What: update&#39;</span> <span class="se">\
</span><span class="se"></span>&gt;   --header <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>&gt;   --data <span class="s1">&#39;{&#34;account&#34;:&#34;xxx@xxx&#34;,&#34;name&#34;:&#34;xxx&#34;}&#39;</span> 

&lt; HTTP/1.1 <span class="m">200</span> OK
<span class="o">{</span><span class="s2">&#34;account&#34;</span>:<span class="s2">&#34;xxx@xxx&#34;</span>,<span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;xxx&#34;</span><span class="o">}</span>
</code></pre></div><h3 id="-query--uri">ä½¿ç”¨ Query æ„é€ è¯·æ±‚ URI<a href="#-query--uri" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>ä½¿ç”¨å®˜æ–¹åŸå§‹çš„ API æ–¹å¼æ„é€  URI éå¸¸ç¹çï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">urlValues</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">Values</span><span class="p">)</span>
<span class="nx">urlValues</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;tom&#34;</span><span class="p">)</span>
<span class="nx">urlValues</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="s">&#34;15&#34;</span><span class="p">)</span>
<span class="nx">path</span> <span class="o">:=</span> <span class="s">&#34;http://localhost?&#34;</span> <span class="o">+</span> <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="p">)</span>
</code></pre></div><p>mplus èƒ½å¤Ÿè®©ä½ çš„ä»£ç æ›´ä¼˜é›…ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">mplus</span><span class="p">.</span><span class="nf">NewQuery</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">AddPairs</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;tom&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="s">&#34;15&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">AppendToURI</span><span class="p">(</span><span class="s">&#34;http://localhost&#34;</span><span class="p">)</span>
</code></pre></div><p>ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½æ˜¯åŒæ ·èƒ½å¤Ÿè¾“å‡º <code>http://localhost?age=15&amp;name=tom</code> ã€‚</p>
<p><strong>mplus</strong> è¿˜èƒ½åšåˆ°æ›´çµæ´»ï¼Œä½¿ç”¨ <code>If</code> åŠ <code>D</code> å‘½åç»“å°¾çš„ç›¸å…³å‡½æ•°èƒ½åŠ¨æ€å†³å®šæ˜¯å¦æ·»åŠ å­—æ®µï¼Œä¸åŸå§‹çš„å®˜æ–¹ API å¤„ç†æ–¹å¼å¯¹æ¯”å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
  <span class="nx">values</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span>
    <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// will be continue
</span><span class="c1"></span>    <span class="s">&#34;age&#34;</span><span class="p">:</span>  <span class="kc">true</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="nx">urlValues</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">Values</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">if</span> <span class="nx">values</span><span class="p">[</span><span class="s">&#34;name&#34;</span><span class="p">]</span> <span class="p">{</span>
  <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;tom&#34;</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">if</span> <span class="nx">values</span><span class="p">[</span><span class="s">&#34;age&#34;</span><span class="p">]</span> <span class="p">{</span>
  <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="s">&#34;15&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;http://localhost/users/%v?&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">NewQuery</span><span class="p">(</span><span class="p">)</span><span class="p">.</span>
           <span class="nf">SetIf</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="s">&#34;name&#34;</span><span class="p">]</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;tom&#34;</span><span class="p">)</span><span class="p">.</span>
           <span class="nf">SetIf</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="s">&#34;age&#34;</span><span class="p">]</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="s">&#34;15&#34;</span><span class="p">)</span><span class="p">.</span>
           <span class="nf">AppendToURIFormat</span><span class="p">(</span><span class="s">&#34;http://localhost/users/%v&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">)</span>

<span class="c1">// OutPut:
</span><span class="c1"></span><span class="c1">// http://localhost/users/1?age=15
</span><span class="c1"></span><span class="c1">// http://localhost/users/1?age=15
</span></code></pre></div><p>å¯¹äºéœ€è¦å»¶è¿Ÿè®¡ç®—çš„èƒ½åŠ›åŒæ ·æ”¯æŒ</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">values</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">{</span>
  <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="c1">// will be continue
</span><span class="c1"></span>  <span class="s">&#34;age&#34;</span><span class="p">:</span>  <span class="s">&#34;15&#34;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">query</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">NewQuery</span><span class="p">(</span><span class="p">)</span><span class="p">.</span>
  <span class="nf">SetIfD</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="s">&#34;name&#34;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">values</span><span class="p">[</span><span class="s">&#34;name&#34;</span><span class="p">]</span><span class="p">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="p">}</span><span class="p">)</span><span class="p">.</span> 
  <span class="nf">SetIfD</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="s">&#34;age&#34;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">values</span><span class="p">[</span><span class="s">&#34;age&#34;</span><span class="p">]</span><span class="p">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="p">}</span><span class="p">)</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span><span class="nx">query</span><span class="p">.</span><span class="nf">AppendToURI</span><span class="p">(</span><span class="s">&#34;http://localhost/users/1&#34;</span><span class="p">)</span><span class="p">)</span>

<span class="c1">// OutPut:
</span><span class="c1"></span><span class="c1">// http://localhost/users/1?age=15
</span></code></pre></div><p>ç”šè‡³ä½ èƒ½å°†å­—æ®µçš„è®¡ç®—ç»Ÿä¸€åšå»¶è¿Ÿå¤„ç†å¹¶å°è£…åˆ°ç‹¬ç«‹çš„å‡½æ•°å†…ä¼ é€’åˆ° Queryï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">query</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">NewQuery</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">SetPairsD</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span> <span class="p">{</span> <span class="c1">// lazy dynamic
</span><span class="c1"></span>  <span class="nx">values</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span>
    <span class="s">&#34;first&#34;</span><span class="p">:</span>  <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#34;second&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s">&#34;third&#34;</span><span class="p">:</span>  <span class="mi">3</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">pairs</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span>

  <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">values</span> <span class="p">{</span>
    <span class="nx">pairs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">pairs</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">pairs</span>
<span class="p">}</span><span class="p">)</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span><span class="nx">query</span><span class="p">.</span><span class="nf">AppendToURI</span><span class="p">(</span><span class="s">&#34;http://localhost/users/1&#34;</span><span class="p">)</span><span class="p">)</span>

<span class="c1">// OutPut:
</span><span class="c1"></span><span class="c1">// http://localhost/users/1?first=1&amp;second=2&amp;third=3
</span></code></pre></div><h3 id="-api-">ä¾¿æ·çš„ API å“åº”<a href="#-api-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>HTTP å“åº”çŠ¶æ€ç æŒ‡ç¤ºç‰¹å®š <a href="https://developer.mozilla.org/zh-cn/HTTP">HTTP</a> è¯·æ±‚æ˜¯å¦å·²æˆåŠŸå®Œæˆã€‚mplus ä¸ºå¸¸ç”¨çš„å“åº”çŠ¶æ€ç æä¾›äº†ä¾¿æ·çš„ APIã€‚</p>
<ul>
<li><code>200`:</code>mplus.PP.OK()`</li>
<li><code>400`:</code>mplus.PP.BadRequest()`</li>
<li><code>401`:</code>mplus.PP.Unauthorized()`</li>
<li><code>403`:</code>mplus.PP.Forbidden()`</li>
<li><code>404`:</code>mplus.PP.NotFound()`</li>
<li><code>405`:</code>mplus.PP.NotAllowed()`</li>
<li><code>408`:</code>mplus.PP.RequestTimeout()`</li>
<li><code>409`:</code>mplus.PP.Conflict()`</li>
<li><code>415`:</code>mplus.PP.UnsupportedMediaType()`</li>
<li><code>500`:</code>mplus.PP.InternalServerError()`</li>
<li>more &hellip;</li>
</ul>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">mr</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span> <span class="c1">// It&#39;s very easy to reuse
</span><span class="c1"></span>	
	<span class="c1">//  response&#39;s status code is 200
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/200&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">OK</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>

	<span class="c1">//  response&#39;s status code is 400
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/400&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">BadRequest</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>

	<span class="c1">//  response&#39;s status code is 401
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/401&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// WWW-Authenticate: Basic
</span><span class="c1"></span>		<span class="c1">// see https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401
</span><span class="c1"></span>		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">WriteRespHeader</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderWWWAuthenticate</span><span class="p">,</span> <span class="s">`</span><span class="s">Basic</span><span class="s">`</span><span class="p">)</span><span class="p">.</span><span class="nf">Unauthorized</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>
  
	<span class="c1">//  response&#39;s status code is 403
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/403&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// chang default Date header
</span><span class="c1"></span>		<span class="c1">// Date: Sat, 28 Sep 2019 01:58:43 GMT
</span><span class="c1"></span>    
		<span class="c1">// TimeFormat is the time format to use when generating times in HTTP
</span><span class="c1"></span>		<span class="c1">// headers. It is like time.RFC1123 but hard-codes GMT as the time
</span><span class="c1"></span>		<span class="c1">// zone. The time being formatted must be in UTC for Format to
</span><span class="c1"></span>		<span class="c1">// generate the correct format.
</span><span class="c1"></span>		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">WriteRespHeader</span><span class="p">(</span>
			<span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderDate</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span><span class="p">.</span><span class="nf">UTC</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">TimeFormat</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">Forbidden</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>
  
	<span class="c1">//  response&#39;s status code is 404
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/404&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">NotFound</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>

	<span class="c1">//  response&#39;s status code is 405
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/405&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// Allow: GET, POST, HEAD
</span><span class="c1"></span>		<span class="c1">// see https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/405
</span><span class="c1"></span>		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">WriteRespHeader</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderAllow</span><span class="p">,</span> <span class="s">&#34;GET,POST,HEAD&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">NotAllowed</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>

	<span class="c1">//  response&#39;s status code is 408
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/408&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// Connection: close
</span><span class="c1"></span>		<span class="c1">// see https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/408
</span><span class="c1"></span>		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">WriteRespHeader</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">HeaderConnection</span><span class="p">,</span> <span class="s">&#34;close&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">RequestTimeout</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>

	<span class="c1">//  response&#39;s status code is 500
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/500&#34;</span><span class="p">,</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">InternalServerError</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>


	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>å“åº”çŠ¶æ€ç ç³»åˆ— API é»˜è®¤æƒ…å†µä¸‹ä¼šé™„å¸¦ <code>Content-Type</code> ä¸º <code>text/plain; charset=utf-8</code> çš„ headerï¼Œå¦‚æœä½ ä¸å–œæ¬¢è¯¥ç³»åˆ— API æä¾›çš„é»˜è®¤è¡Œä¸ºï¼Œä½ å¯ä»¥å¯¹å…¶è¡Œä¸ºè¿›è¡Œæ›´æ”¹ï¼š</p>
<ul>
<li><code>mplus.RegisterHttpStatusMethod</code> æ›´æ”¹æŒ‡å®š HTTP çŠ¶æ€ç çš„å“åº”å¤„ç†</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">(</span><span class="p">)</span>

	<span class="c1">// register a StatusBadRequest hook to change default&#39;s behavior
</span><span class="c1"></span>	<span class="nx">mplus</span><span class="p">.</span><span class="nf">RegisterHttpStatusMethod</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> 
                      <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">m</span> <span class="nx">message</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// {&#34;err_message&#34;:&#34;Bad Request&#34;} 400 Bad Request
</span><span class="c1"></span>		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">mplus</span><span class="p">.</span><span class="nx">Data</span><span class="p">{</span><span class="s">&#34;err_message&#34;</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nf">En</span><span class="p">(</span><span class="p">)</span><span class="p">}</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Status</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span>

	<span class="c1">//  response&#39;s status code is 400
</span><span class="c1"></span>	<span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/400&#34;</span><span class="p">,</span>  <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span><span class="p">.</span><span class="nf">BadRequest</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>

	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl http://localhost:8080/400

&lt; HTTP/1.1 <span class="m">400</span> Bad Request
<span class="o">{</span><span class="s2">&#34;err_message&#34;</span>:<span class="s2">&#34;Bad Request&#34;</span><span class="o">}</span>
</code></pre></div><h3 id="-errcode--api-">ä½¿ç”¨ errCode è§„åˆ’ API å“åº”ä¸åŒæ•°æ®å†…å®¹<a href="#-errcode--api-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>åœ¨ API å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸éœ€è¦å¯¹ä¸åŒçš„æƒ…å†µåšä¸åŒçš„å“åº”å¤„ç†å¹¶è¿”å›å¯¹åº”çš„æ•°æ®ç»“æœï¼Œç¬¬ä¸‰æ–¹é€šè¿‡å“åº”çš„æ•°æ®ç»“æœå†…å®¹åˆ¤æ–­ API è¯·æ±‚å®Œæˆæƒ…å†µã€‚</p>
<p><strong>mplus</strong> è®¾è®¡äº†ä¸€å¥—é€šè¿‡ <code>errCode</code> æ³¨å†Œä¸åŒçš„å“åº”ç»“æœå¤„ç†é€»è¾‘ï¼Œåœ¨ Handler ä¸­åªéœ€è¦å°†é¢„å…ˆå®šä¹‰å¥½çš„ <code>errCode</code> ä¼ é€’åˆ° mplusï¼Œmplus å°±èƒ½å¤Ÿå¯¹å…¶æ‰§è¡Œé¢„å…ˆæ³¨å†Œçš„é€»è¾‘å®Œæˆå‰©ä½™çš„å“åº”å·¥ä½œï¼Œè€Œå®Œæˆè¿™ä¸ªåŠŸèƒ½çš„åª’ä»‹å³ <code>Message</code>ã€‚</p>
<ul>
<li>
<p><code>mplus.NewCallbackMessage(int,int,string,CallbackMessage)</code> åˆ›å»ºä¸€ä¸ªé™„å¸¦<code>Callbcak</code> çš„ <code>Message</code></p>
</li>
<li>
<p><code>mplus.Messages.Add(Message)</code>  æ·»åŠ ä¸€ä¸ª <code>Message</code></p>
</li>
<li>
<p><code>mplus.pp.CallbackByCode(int,interface{})</code> é€šè¿‡ <code>errCode</code> è§¦å‘æŒ‡å®šçš„ <code>Callback</code></p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">V</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Addr</span> <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;addr&#34; validate:&#34;min=10&#34;</span><span class="s">`</span> <span class="c1">// min len is 10
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// errCode 400001
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">ErrCodeAddrNotExists</span> <span class="p">=</span> <span class="mi">400001</span>

<span class="c1">// ErrCodeCallbackFun will be perform when ErrCodeAddrNotExists be use to PP.CallbackByCode
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ErrCodeCallbackFun</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">m</span> <span class="nx">mplus</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">respData</span> <span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span> <span class="p">{</span>
  
	<span class="c1">// {&#34;code&#34;:400001,&#34;message&#34;:&#34;addr not exists&#34;}
</span><span class="c1"></span>	<span class="nx">mplus</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nx">Data</span><span class="p">{</span><span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nf">En</span><span class="p">(</span><span class="p">)</span><span class="p">}</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Status</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">CheckAddr</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>

	<span class="c1">// register a message for ErrCodeAddrNotExists
</span><span class="c1"></span>	<span class="nx">mplus</span><span class="p">.</span><span class="nx">Messages</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span>
		<span class="nx">mplus</span><span class="p">.</span><span class="nf">NewCallbackMessage</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">ErrCodeAddrNotExists</span><span class="p">,</span> <span class="s">&#34;addr not exists&#34;</span><span class="p">,</span> <span class="nx">ErrCodeCallbackFun</span><span class="p">)</span><span class="p">)</span>

	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Address</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Handler
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Address</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">!</span><span class="nf">CheckAddr</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nf">VO</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">//  pp search ErrCodeAddrNotExists message  pass to ErrCodeCallbackFun
</span><span class="c1"></span>		<span class="c1">// second arg is respData pass to registered callback func on Messages -&gt; ErrCodeCallbackFun
</span><span class="c1"></span>		<span class="nx">pp</span><span class="p">.</span><span class="nf">CallbackByCode</span><span class="p">(</span><span class="nx">ErrCodeAddrNotExists</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">pp</span><span class="p">.</span><span class="nf">JSONOK</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="c1">// pass nil will specify mplus.EmptyRespData
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ curl --request POST <span class="se">\
</span><span class="se"></span>&gt;   --url http://localhost:8080/ <span class="se">\
</span><span class="se"></span>&gt;   --header <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>&gt;   --data <span class="s1">&#39;{&#34;addr&#34;:&#34;å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒº xxx å·&#34;}&#39;</span>

&lt; HTTP/1.1 <span class="m">400</span> Bad Request
<span class="o">{</span><span class="s2">&#34;code&#34;</span>:400001,<span class="s2">&#34;message&#34;</span>:<span class="s2">&#34;addr not exists&#34;</span><span class="o">}</span>
</code></pre></div><h3 id="-requestbody">é‡å¤è¯»å– request.Body<a href="#-requestbody" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>ç”±äº<code>request.Body</code> æ˜¯ä¸€ä¸ª <code>io.ReadCloser</code> å®ä¾‹ï¼Œé»˜è®¤æ²¡æœ‰æä¾›é‡å¤è¯»å–çš„èƒ½åŠ›ã€‚<strong>mplus</strong> æä¾›äº†API åœ¨ä¿ç•™  <code>request.Body</code> è¯»å–æ•°æ®èƒ½åŠ›çš„åŒæ—¶è·å–æ•°æ®å†…å®¹ã€‚</p>
<ul>
<li><code>mplus.PP.ReqBody()</code> ä¿æŒ <code>request.Body</code> å¯ç”¨å¹¶è¿”å› <code>string</code> æ ¼å¼çš„ body å†…å®¹</li>
<li><code>mplus.PP.ReqBodyPure()</code> ä¿æŒ <code>request.Body</code> å¯ç”¨å¹¶è¿”å› <code>[]byte</code> æ ¼å¼çš„ body å†…å®¹</li>
<li><code>mplus.PP.ReqBodyMap()</code> ä¿æŒ <code>request.Body</code> å¯ç”¨å¹¶è¿”å› <code>map[string]interface{}</code> æ ¼å¼çš„ body å†…å®¹</li>
<li><code>mplus.PP.ReqBodyToUnmarshaler(unmarshaler json.Unmarshaler) </code> ä¿æŒ <code>request.Body</code> å¯ç”¨å¹¶å°† body å†…å®¹åºåˆ—åŒ–åˆ°   unmarshaler</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">V</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Addr</span> <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;addr&#34;</span><span class="s">`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// (*V)(nil) mean that is a nil point which hold type info
</span><span class="c1"></span>	<span class="c1">// Bind model just need type info
</span><span class="c1"></span>	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">MRote</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Address</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Address</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pp</span> <span class="o">:=</span> <span class="nx">mplus</span><span class="p">.</span><span class="nf">PlusPlus</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>

	<span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">pp</span><span class="p">.</span><span class="nf">VO</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">V</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">pp</span><span class="p">.</span><span class="nf">BadRequest</span><span class="p">(</span><span class="p">)</span> <span class="c1">// 400
</span><span class="c1"></span>		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nb">string</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nf">ReqBodyPure</span><span class="p">(</span><span class="p">)</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">pp</span><span class="p">.</span><span class="nf">ReqBody</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>

		<span class="nx">pp</span><span class="p">.</span><span class="nf">InternalServerError</span><span class="p">(</span><span class="p">)</span> <span class="c1">// 500
</span><span class="c1"></span>		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">bodyMap</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pp</span><span class="p">.</span><span class="nf">ReqBodyMap</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Addr</span> <span class="o">!=</span> <span class="nx">bodyMap</span><span class="p">[</span><span class="s">&#34;addr&#34;</span><span class="p">]</span> <span class="p">{</span>

		<span class="nx">pp</span><span class="p">.</span><span class="nf">InternalServerError</span><span class="p">(</span><span class="p">)</span> <span class="c1">// 500
</span><span class="c1"></span>		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">pp</span><span class="p">.</span><span class="nf">OK</span><span class="p">(</span><span class="p">)</span> <span class="c1">// 200
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ curl --request POST <span class="se">\
</span><span class="se"></span>&gt; --url http://localhost:8080/ <span class="se">\
</span><span class="se"></span>&gt; --header <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>&gt; --data <span class="s1">&#39;{&#34;addr&#34;:&#34;å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒº xxx å·&#34;}&#39;</span>

&lt; HTTP/1.1 <span class="m">200</span> OK 
</code></pre></div>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>tangzixiang</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2097 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>Wednesday, Jan 21, 2015</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#-mplus">å¼•å…¥ mplus</a></li>
    <li><a href="#heading">å¿«é€Ÿå¼€å§‹</a></li>
    <li><a href="#heading1">åŠŸèƒ½</a>
      <ul>
        <li><a href="#heading2">ä½¿ç”¨è‡ªå®šä¹‰ä¸­é—´ä»¶</a></li>
        <li><a href="#-model-">ç»‘å®š model å¹¶æ ¡éªŒè¯·æ±‚æ•°æ®æœ‰æ•ˆæ€§</a></li>
        <li><a href="#-query--uri">ä½¿ç”¨ Query æ„é€ è¯·æ±‚ URI</a></li>
        <li><a href="#-api-">ä¾¿æ·çš„ API å“åº”</a></li>
        <li><a href="#-errcode--api-">ä½¿ç”¨ errCode è§„åˆ’ API å“åº”ä¸åŒæ•°æ®å†…å®¹</a></li>
        <li><a href="#-requestbody">é‡å¤è¯»å– request.Body</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			
			<a class="next-post" href="https://mp.weixin.qq.com/s/cxAdWg0jqnNovE47YGWjUA" target="_brank">
			
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>[GO] å¦‚ä½•æ­£ç¡®çš„å¼€å§‹ç”¨Goç¼–ç¨‹</span>
			</a>
			
			<a class="prev-post" href="https://tangzixiang.github.io/posts/2019/%E4%BD%BF%E7%94%A8-hugo-%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0/">
			
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>ä½¿ç”¨ Hugo å‘å¸ƒæ–‡ç« </span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://tangzixiang.github.io/">tangzixiang</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://tangzixiang.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://tangzixiang.github.io/js/bundle.min.02650e0c77fc1bfcad495b29610bd935bfc2daa155fc2970de097faba7042224.js" integrity="sha256-AmUODHf8G/ytSVspYQvZNb/C2qFV/Clw3gl/q6cEIiQ=" crossorigin="anonymous"></script>
	

</body>

</html>
